<%- include('../partials/navbar') %>

<div class="container mx-auto my-10 max-w-md">
    <h1 class="text-4xl font-bold mb-8 text-gray-800"><%= title %></h1>

    <div class="bg-white p-8 rounded-lg shadow-2xl text-center">
        <h2 class="text-2xl font-semibold mb-4">Total Payable:</h2>
        <p class="text-5xl price-display font-extrabold mb-8">$<%= totalAmountDisplay %></p>

        <button id="rzp-button1" class="w-full btn-primary btn bg-blue-600 hover:bg-blue-700">Pay Now with Razorpay</button>

        <p class="text-sm text-gray-500 mt-4">Order ID: <%= orderId %></p>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    // Using JSON.stringify() ensures all strings are properly quoted and escaped.
    var options = {
        key: <%= JSON.stringify(razorpayKey) %>,
        amount: <%= amount %>, // Number, does not need quotes
        currency: "INR", 
        name: "ECOM Checkout",
        description: <%= JSON.stringify("Payment for Order #" + orderId) %>,
        order_id: <%= JSON.stringify(orderId) %>,
        handler: function (response) {
            // Success handler: Populate hidden form fields and submit
            document.getElementById('razorpay_order_id').value = response.razorpay_order_id;
            document.getElementById('razorpay_payment_id').value = response.razorpay_payment_id;
            document.getElementById('razorpay_signature').value = response.razorpay_signature;
            document.getElementById('payment-form').submit(); 
        },
        prefill: {
            name: <%= JSON.stringify(user.name) %>,
            email: <%= JSON.stringify(user.email) %>,
            // Ensure this is an empty string if user.contact is undefined
            contact: "" 
        },
        theme: {
            color: "#3b82f6"
        }
    };

    var rzp1 = new Razorpay(options);

    // Attach the click handler to our custom button
    document.getElementById('rzp-button1').onclick = function(e) {
        rzp1.open();
        e.preventDefault();
    }
</script>

<form id="payment-form" action="/orders/verify-payment" method="POST" style="display: none;">
    <input type="hidden" name="razorpay_order_id" id="razorpay_order_id">
    <input type="hidden" name="razorpay_payment_id" id="razorpay_payment_id">
    <input type="hidden" name="razorpay_signature" id="razorpay_signature">
</form>

<%- include('../partials/footer') %>